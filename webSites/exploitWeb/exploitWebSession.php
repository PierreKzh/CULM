<!DOCTYPE html>
<html lang="fr">
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <!--choix de l'encodage des caractères-->
        <meta charset="utf-8">
        <!--titre de la page internet-->
        <title>Connexion</title>
        <!--icone à coté du titre-->
        <link rel="icon" href="assets/cadena.png">
        <!--liaison avec le fichier css-->
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/exploitWebSession.css">
        <!--liaison avec fichier javaScript-->
        <script type="text/javascript" src="js/exploitWeb.js"></script>
    </head>
    <body>
        <br><br><br><br>
        <center>
            <!--Création du formulaire de connexion-->
            <div class="container session">
                <form method="POST" action="exploitWebSession.php">
                    <table>
                        <tr>
                            <td><center><h2>CULM</h2></center></td>
                        </tr>
                        <tr>
                            <td><center><p>Connexion formateur à exploitWeb</p></center><br><br></td>
                        </tr>
                        <tr>
                            <!--Input pour rentrer son identifiant-->
                            <td><center><input type="text" placeholder="Identifiant" maxlength="50" name="login" id="login" oninput=validation()></center><br></td>
                        </tr>
                        <tr>
                            <!--Input pour rentrer son mot de passe-->
                            <td><center><input type="password" placeholder="Mot de passe" maxlength="500" name="password" id="password" oninput=validation()></center><br><br></td>
                        </tr>
                        <tr>
                            <!--boutton pour valider et se connecter à exploitWeb-->
                            <td><center><input type="submit" value="Connexion" id="connection" disabled="disabled"></center><br><br><br></td>
                        </tr>
                        <tr>
                        <!--mesage pour les alertes-->
                            <td><center><h5 id="alert"></h5></center></td>
                        </tr>
                    </table>
                </form>
            </div>
        </center>

        <?php
            //si les champs ne sont pas vide, on fait le traitement
            if(!empty($_POST['login'])){
                //initialisation des variable pour la bdd
                include("php/connexionBDD.php");

                //si erreur de connection
                if (!mysqli_connect($host, $user, $userpassword, 'CULM')) {
                    //echo "Echec lors de la connexion à MySQL : (" . $mysqli->connect_errno . ") " . $mysqli->connect_error;
                    ?>
                    <!--affichage du message-->
                    <script>alertMsg("Une erreur est survenue", "red")</script>
                    <?php
                }
                else{
                    //si les champs de connexion ne sont pas vide
                    if(!empty($_POST['login']) and !empty($_POST['password'])){
                        //on recupère la valeur du mdp pour le login que la personne a rentré
                        $compte = mysqli_query($link, "select mdp from T_COMPTE where login = '".$_POST['login']."';");
                        $compteResult = mysqli_fetch_array($compte);
                        //on hash le mdp que la personne a rentré
                        $hash = md5($_POST['password']);
                        //si les deux valeurs ne correspondent pas
                        if($hash != $compteResult['mdp']){
                            ?>
                            <!--affichage du message-->
                            <script>alertMsg("Identifiant ou mot de passe incorrect", "orange")</script>
                            <?php
                        }
                        else{
                            //sinon on démare la session
                            session_start();
                            //les valeurs de login et mdp sont ajouté à la session
                            $_SESSION['login'] = $_POST['login'];
                            $_SESSION['password'] = $hash;

                            //fermeture de la connection à la bdd
                            mysqli_close();

                            //puis on redirige vers la page principale
                            header('Location: exploitWeb.php');
                        }
                    }
                }
                //fermeture de la connection à la bdd
                mysqli_close();
            }   
        ?>
    </body>
</html>