<!--inclusion de la connexion bdd-->
<?php 
include("connexionBDD.php"); 
session_start();
if (isset($_SESSION['login']) && isset($_SESSION['password'])){
?>
    <center>
        <!--tableau des données, première ligne-->
        <table border="0" class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Nom</th>
                    <th scope="col">Prenom</th>
                    <th scope="col">DateNaissance</th>
                    <th scope="col">Code</th>
                    <th scope="col">Date&Heure</th>
                    <th scope="col">Argumentation</th>
                    <th scope="col">Erreur</th>
                    <th scope="col"><input <?php echo($_SESSION['choixBoxesForm']); ?> id="choixBoxes" onClick="allBoxes()" type="checkbox" class="form-check-input"></th>
                </tr>
            </thead>
            <?php
            if($link){
                function tab($etudiant, $examen, $prelevement, $cpt){
                    //fonction qui affiche les éléments dans le tableau
                    echo('<tr>
                            <th scope="row">'.$cpt.'</th>
                            <td>'.$etudiant['nom'].'</td>
                            <td>'.$etudiant['prenom'].'</td>
                            <td>'.$etudiant['date_naissance'].'</td>
                            <td>'.$examen['code'].'</td>
                            <td>'.$examen['date'].'</td>
                            <td>'.$prelevement['justification'].'</td>
                            <td>'.$prelevement['fautes'].'</td>
                            <td><input ');

                    echo($valeur = ($_SESSION['checkbox'][$cpt-1] == 1) ? "checked" : "");
                    echo(' name='."check".$cpt.' id='."check".$cpt.' class="form-check-input" onClick="checkBox()" type="checkbox"></td></tr>');
                    
                    //récupération des informations dans la session
                    $_SESSION['compteur'] = $cpt;
                    $_SESSION['nom'.$cpt] = $etudiant['nom'];
                    $_SESSION['prenom'.$cpt] = $etudiant['prenom'];
                    $_SESSION['date_n'.$cpt] = $etudiant['date_naissance'];
                    $_SESSION['code'.$cpt] = $examen['code'];
                    $_SESSION['date'.$cpt] = $examen['date'];
                    $_SESSION['justification'.$cpt] = $prelevement['justification'];
                    $_SESSION['fautes'.$cpt] = $prelevement['fautes'];
                }

                function rechercheResultat($link, $requeteEtudiant, $ordre){
                    //fonction qui récupère la connection à la bdd, des requêtes
                    //et executes ces requêtes pour récupérer les données dans la base de données
                    //variable compteur pour les id de chaque lignes du tableau
                    $cpt = 0;
                    $etudiantPrepa = mysqli_query($link, $requeteEtudiant);
                    while($etudiant = mysqli_fetch_assoc($etudiantPrepa)){
                        $examenPrepa = mysqli_query($link, "select * from T_EXAMEN where fk_etudiant = '".$etudiant['id_etudiant']."'".$ordre.";");
                        while($examen = mysqli_fetch_assoc($examenPrepa)){
                            $prelevementPrepa = mysqli_query($link, "select * from T_PRELEVEMENT where id_prelevement = '".$examen['fk_prelevement']."';");
                            $prelevement = mysqli_fetch_array($prelevementPrepa);
                            $cpt++;

                            //puis appel la fonction tab()
                            tab($etudiant, $examen, $prelevement, $cpt);
                        }
                    }
                    echo('<input name="compteur" id="compteur" type=hidden value="'.$cpt.'">');
                }

                $menuDeroulant = $_SESSION['rechercheSelect'];
                $nomEtudiant = $_SESSION['rechercheNom'];
                //echo("nom = ".$nomEtudiant."</br>select = ".$menuDeroulant);

                //si un nom de recherche est entré
                if(!empty($nomEtudiant)){
                    //et que le menu déroulant est choisis sur date croissante/décroissante
                    //on recherche en fonction du nom et de la date
                    if($menuDeroulant == "Date croissante" || $menuDeroulant == "Date décroissante"){
                        $ordre = ($menuDeroulant == "Date croissante") ? "order by date asc" : "order by date desc";

                        $requeteEtudiant = "select * from T_ETUDIANT where nom = '".$nomEtudiant."';";
                        rechercheResultat($link, $requeteEtudiant, $ordre);
                    }
                    //sinon on recherche juste en fonction du nom
                    else{
                        $requeteEtudiant = "select * from T_ETUDIANT where nom = '".$nomEtudiant."';";
                        rechercheResultat($link, $requeteEtudiant, "");
                    }
                }
                //sinon si juste le choix entre ordre alpha.. croissant/décroissant est choisis
                elseif($menuDeroulant == "Ordre alphabétique croissant" || $menuDeroulant == "Ordre alphabétique décroissant"){
                    $ordre = ($menuDeroulant == "Ordre alphabétique croissant") ? "order by nom asc" : "order by nom desc";

                    $requeteEtudiant = "select * from T_ETUDIANT ".$ordre.";";
                    rechercheResultat($link, $requeteEtudiant, "");
                }
                //sinon si juste le choix entre date croissante/décroissante est choisis
                elseif($menuDeroulant == "Date croissante" || $menuDeroulant == "Date décroissante"){
                    $ordre = ($menuDeroulant == "Date croissante") ? "asc" : "desc";

                    //on execute les requetes pour récupérer les données demandé
                    $examenPrepa = mysqli_query($link, "select * from T_EXAMEN order by date ".$ordre.";");
                    while($examen = mysqli_fetch_assoc($examenPrepa)){
                        $etudiantPrepa = mysqli_query($link, "select * from T_ETUDIANT where id_etudiant = '".$examen['fk_etudiant']."';");
                        $etudiant = mysqli_fetch_array($etudiantPrepa);
                        $prelevementPrepa = mysqli_query($link, "select * from T_PRELEVEMENT where id_prelevement = '".$examen['fk_prelevement']."';");
                        $prelevement = mysqli_fetch_array($prelevementPrepa);

                        tab($etudiant, $examen, $prelevement);
                    }
                }
                //sinon on affiche le tableau entier(que au lancement de la page)
                else{
                    $requeteEtudiant = "select * from T_ETUDIANT order by nom asc;";
                    rechercheResultat($link, $requeteEtudiant, "");
                }
                
                //fermeture de la bdd
                mysqli_close();
            }
            else{
                //sinon bdd éteinte, affichage erreur
                echo('<tr><td colspan = "7" style="color: red;"><center><h4>Une erreur est survenue</h4></center></td></tr>');
            }
            ?>
        </table>
    </center>
    <br>
<?php
}
else{
    header('Location: ../exploitWebSession.php');
  }
?>