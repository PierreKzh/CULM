<!--inclusion de la connexion bdd-->
<?php include("connexionBDD.php"); ?>

<center>
    <!--tableau des données, première ligne-->
    <table border="0">
        <tr style= "border: 1px solid black;">
            <th style= "border: 1px solid black;">&nbspNom&nbsp</th>
            <th style= "border: 1px solid black;">&nbspPrenom&nbsp</th>
            <th style= "border: 1px solid black;">&nbspDateNaissance&nbsp</th>
            <th style= "border: 1px solid black;">&nbspCode&nbsp</th>
            <th style= "border: 1px solid black;">&nbspDate&Heure&nbsp</th>
            <th style= "border: 1px solid black;">&nbspArgumentation&nbsp</th>
            <th colspan="2" style= "border: 1px solid black;">&nbspErreur&nbsp</th>
        </tr>
        <tr><td><br></td></tr>
        <?php
        if($link){
            //fonction qui affiche les éléments dans le tableau
            function tab($etudiant, $examen, $prelevement, $cpt){
                echo('
                    <tr>
                        <td style= "border-bottom: 1px solid black;">'.$etudiant['nom'].'&nbsp&nbsp</td>
                        <td style= "border-bottom: 1px solid black;">'.$etudiant['prenom'].'</td>
                        <td style= "border-bottom: 1px solid black;">'.$etudiant['date_naissance'].'</td>
                        <td style= "border-bottom: 1px solid black;">'.$examen['code'].'&nbsp</td>
                        <td style= "border-bottom: 1px solid black;">'.$examen['date'].'&nbsp</td>
                        <td style= "border-bottom: 1px solid black;">'.$prelevement['justification'].'&nbsp</td>
                        <td style= "border-bottom: 1px solid black;">'.$prelevement['fautes'].'</td>
                        <td id='.$cpt.' style= "border-bottom: 1px solid black;">&nbsp&nbsp<input id='.$cpt.' type="checkbox"></td>
                    </tr>
                ');
            }

            function rechercheResultat($link, $requeteEtudiant, $ordre){
                //fonction qui réucpre la connection à la bdd, des requêtes
                //et executes ces requêtes pour récupérer les données dans la base de données
                //variable compteur pour les id de chaque lignes du tableau
                $cpt = 0;
                $etudiantPrepa = mysqli_query($link, $requeteEtudiant);
                while($etudiant = mysqli_fetch_assoc($etudiantPrepa)){
                    $examenPrepa = mysqli_query($link, "select * from T_EXAMEN where fk_etudiant = '".$etudiant['id_etudiant']."'".$ordre.";");
                    while($examen = mysqli_fetch_assoc($examenPrepa)){
                        $prelevementPrepa = mysqli_query($link, "select * from T_PRELEVEMENT where id_prelevement = '".$examen['fk_prelevement']."';");
                        $prelevement = mysqli_fetch_array($prelevementPrepa);
                        $cpt++;

                        //puis appel la fonction tab()
                        tab($etudiant, $examen, $prelevement, $cpt);
                    }
                }
            }

            $menuDeroulant = $_POST['rechercheSelect'];
            $nomEtudiant = $_POST['rechercheNom'];
            //echo("nom = ".$nomEtudiant."</br>select = ".$menuDeroulant);

            //si un nom de recherche est entré
            if(!empty($nomEtudiant)){
                //et que le menu déroulant est choisis sur date croissante/décroissante
                //on recherche en fonction du nom et de la date
                if($menuDeroulant == "Date croissante" || $menuDeroulant == "Date décroissante"){
                    $ordre = ($menuDeroulant == "Date croissante") ? "order by date asc" : "order by date desc";

                    $requeteEtudiant = "select * from T_ETUDIANT where nom = '".$nomEtudiant."';";
                    rechercheResultat($link, $requeteEtudiant, $ordre);
                }
                //sinon on recherche juste en fonction du nom
                else{
                    $requeteEtudiant = "select * from T_ETUDIANT where nom = '".$nomEtudiant."';";
                    rechercheResultat($link, $requeteEtudiant, "");
                }
            }
            //sinon si juste le choix entre ordre alpha.. croissant/décroissant est choisis
            elseif($menuDeroulant == "Ordre alphabétique croissant" || $menuDeroulant == "Ordre alphabétique décroissant"){
                $ordre = ($menuDeroulant == "Ordre alphabétique croissant") ? "order by nom asc" : "order by nom desc";

                $requeteEtudiant = "select * from T_ETUDIANT ".$ordre.";";
                rechercheResultat($link, $requeteEtudiant, "");
            }
            //sinon si juste le choix entre date croissante/décroissante est choisis
            elseif($menuDeroulant == "Date croissante" || $menuDeroulant == "Date décroissante"){
                $ordre = ($menuDeroulant == "Date croissante") ? "asc" : "desc";

                //on execute les requetes pour récupérer les données demandé
                $examenPrepa = mysqli_query($link, "select * from T_EXAMEN order by date ".$ordre.";");
                while($examen = mysqli_fetch_assoc($examenPrepa)){
                    $etudiantPrepa = mysqli_query($link, "select * from T_ETUDIANT where id_etudiant = '".$examen['fk_etudiant']."';");
                    $etudiant = mysqli_fetch_array($etudiantPrepa);
                    $prelevementPrepa = mysqli_query($link, "select * from T_PRELEVEMENT where id_prelevement = '".$examen['fk_prelevement']."';");
                    $prelevement = mysqli_fetch_array($prelevementPrepa);

                    tab($etudiant, $examen, $prelevement);
                }
            }
            //sinon on affiche le tableau entier(que au lancement de la page)
            else{
                $requeteEtudiant = "select * from T_ETUDIANT order by nom asc;";
                rechercheResultat($link, $requeteEtudiant, "");
            }

            //fermeture de la bdd
            mysqli_close();
        }
        else{
            //sinon bdd éteinte, affichage erreur
            echo('<tr><td colspan = "7" style="color: red;"><center><h4>Une erreur est survenue</h4></center></td></tr>');
        }
        ?>
    </table>
</center>
<br>