<?php
//début de la session, récupération des infos
session_start();
if (isset($_SESSION['login']) && isset($_SESSION['password'])){
    //initialisation des variables utiles
    $nbMax = $_SESSION['compteur'];
    $checkbox = $_SESSION['checkbox'];
    $tabEtudiant = array('nom', 'prenom', 'date_n', 'code', 'date', 'justification', 'fautes');
    //création d'un tableau à deux dimmensions
    $tabEtudiantValeurs = array(array());
    $testBox = 0;

    //on ajoute dans le tableau à deux dimmensions, les valeurs de tous les étudiants
    for($i=0; $i<=$nbMax-1; $i++){
        for($h=0; $h<=6; $h++){
            $tabEtudiantValeurs[$i][$h] = $_SESSION[$tabEtudiant[$h].($i+1)];
        }
    }

    //on créer le header l'envoie des données
    header("Content-Type: text/plain");
    header("Content-disposition: attachment; filename=CULM_resultats.csv");

    //on crée le fichier csv à sortir
    $out = fopen('PHP://output', 'w');
    //on insert une ligne
    fputcsv($out, $tabEtudiant);

    //on ajoute dans le fichier csv les valeurs des étudiants selectionnées
    //comme pour le pdf
    for($i=0; $i<=$nbMax; $i++){
        if($checkbox[$i] == 1){
            fputcsv($out, $tabEtudiantValeurs[$i]);
            $testBox++;
        }
    }
    if($testBox == 0){
        for($i=0; $i<=$nbMax; $i++){
            fputcsv($out, $tabEtudiantValeurs[$i]);
        }
    }
    //puis on ferme le fichier
    fclose($out);

}
//si session non connnecté direction page connexion
else{
  header('Location: ../exploitWebSession.php');
}
?>